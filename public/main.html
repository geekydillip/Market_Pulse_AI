<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Pulse - VOC Intelligence</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
            },
          },
        },
      },
    }


    // System theme detection
    function updateTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.classList.toggle('dark', isDark);
    }

    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);

    // Set initial theme
    updateTheme();
  </script>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans min-h-screen">
  <div class="max-w-100% mx-auto px-6 py-6">

    <!-- HEADER -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100">MARKET PULSE AI DASHBOARD</h1>

      <div class="flex gap-2">
        <a href="aiprocessor.html"
          class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-slate-600 to-indigo-600 hover:from-slate-700 hover:to-indigo-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
          <i class="fa-solid fa-brain mr-2"></i>
          AI PROCESSOR
        </a>
      </div>
    </div>



    <!-- CATEGORY BUTTONS -->
    <section class="flex flex-wrap gap-3 mb-5 justify-center">
      <a href="GLOBAL_VOC_PLM_Dashboard.html"
        class="w-auto px-6 py-2 bg-gradient-to-r from-slate-600 to-emerald-600 hover:from-slate-700 hover:to-emerald-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
        <i class="fa-solid fa-globe mr-2"></i>
        GLOBAL VOC PLM
      </a>
      <a href="BetaUT_Dashboard.html"
        class="w-auto px-6 py-2 bg-gradient-to-r from-slate-700 to-teal-600 hover:from-slate-800 hover:to-teal-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
        <i class="fa-solid fa-mobile-screen mr-2"></i>
        BETA UT
      </a>
      <a href="employee_ut_Dashboard.html"
        class="w-auto px-6 py-2 bg-gradient-to-r from-slate-700 to-lime-600 hover:from-slate-800 hover:to-lime-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
        <i class="fa-solid fa-trophy mr-2"></i>
        EMPLOYEE UT
      </a>
      <a href="SMVOC_Dashboard.html"
        class="w-auto px-6 py-2 bg-gradient-to-r from-slate-700 to-purple-600 hover:from-slate-800 hover:to-purple-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
        <i class="fa-solid fa-comments mr-2"></i>
        SAMSUNG MEMBERS VOC
      </a>
      <button
        class="w-auto px-6 py-2 bg-gradient-to-r from-slate-700 to-orange-600 hover:from-slate-800 hover:to-orange-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
        <i class="fa-solid fa-question-circle mr-2"></i>
        SERVICE ISSUE
      </button>
    </section>

    <!-- CHARTS ROW REMOVED -->



    <!-- MODEL SUMMARY TABLE -->
    <section class="mt-8">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
        <!-- Header with subtle accent -->
        <div class="border-b border-slate-100 dark:border-slate-700 px-6 py-2">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Top Critical Market Issues</h3>
            <div class="w-8 h-8 bg-green-50 dark:bg-green-950/30 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-table text-green-600 dark:text-green-400"></i>
            </div>
          </div>
        </div>

        <!-- Table Container -->
        <div class="overflow-x-auto overflow-y-auto max-h-[550px]">
          <table class="w-full">
            <thead
              class="bg-slate-200 dark:bg-slate-900 sticky top-0 z-10 border-b-2 border-slate-300 dark:border-slate-800">
              <tr class="divide-x divide-slate-300 dark:divide-slate-700">
                <th
                  class="w-16 px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">
                  SL. NO.</th>
                <th onclick="sortTable('source')"
                  class="w-32 px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>SOURCE</span><i id="sort-icon-source"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
                <th onclick="sortTable('model')"
                  class="px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>MODEL NUMBER</span><i
                      id="sort-icon-model"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
                <th onclick="sortTable('chipset')"
                  class="px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>CHIPSET</span><i id="sort-icon-chipset"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
                <th onclick="sortTable('plm')"
                  class="px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>PLM CODE</span><i id="sort-icon-plm"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
                <th onclick="sortTable('title')"
                  class="px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>TITLE</span><i id="sort-icon-title"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
                <th onclick="sortTable('status')"
                  class="px-4 py-3 text-center align-middle text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider cursor-pointer hover:bg-slate-300 dark:hover:bg-slate-800 group select-none transition-colors">
                  <div class="flex items-center justify-center space-x-1"><span>STATUS</span><i id="sort-icon-status"
                      class="fa-solid fa-sort text-slate-400 dark:text-slate-500 group-hover:text-slate-600 dark:group-hover:text-slate-400"></i>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="model-summary-table-body"
              class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Dynamic content will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- DETAILS MODAL -->
  <div id="details-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeDetailsModal()"></div>
    <div
      class="relative mx-auto my-8 max-w-4xl max-h-[90vh] bg-white dark:bg-slate-800 rounded-xl shadow-xl flex flex-col overflow-hidden">
      <div
        class="flex justify-between items-center px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
        <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100">Detailed Model Analysis</h2>
        <button class="text-slate-400 hover:text-slate-600 dark:text-slate-300 text-2xl leading-none"
          onclick="closeDetailsModal()">Ã—</button>
      </div>
      <div class="flex-1 overflow-y-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-slate-100" id="modal-total-models">0</div>
            <div class="text-sm text-slate-600 dark:text-slate-400">Total Models</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-slate-100" id="modal-total-issues">0</div>
            <div class="text-sm text-slate-600 dark:text-slate-400">Total Issues</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="modal-high-risk">0</div>
            <div class="text-sm text-slate-600 dark:text-slate-400">High Risk Models</div>
          </div>
        </div>
        <div class="overflow-x-auto border border-slate-200 dark:border-slate-700 rounded-lg">
          <table class="w-full">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Rank</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Model</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Module</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Source</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Issues</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Severity</th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                  Risk Level</th>
              </tr>
            </thead>
            <tbody id="modal-table-body"
              class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <!-- Dynamic content will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let dashboardData = {
      kpis: {},
      topModels: [],
      topModules: []
    };
    let globalTableData = [];
    let currentSortColumn = '';
    let isAscending = true;
    let modelNameMapping = {}; // Model name mapping from modelName.json

    // Load model name mapping
    async function loadModelNameMapping() {
      try {
        const response = await fetch('/modelName.json');
        modelNameMapping = await response.json();
        console.log(`Loaded ${Object.keys(modelNameMapping).length} model name mappings`);
      } catch (error) {
        console.warn('Failed to load modelName.json:', error);
        modelNameMapping = {};
      }
    }

    // Apply model name mapping function
    function applyModelNameMapping(modelNumber) {
      if (!modelNumber || typeof modelNumber !== 'string') return modelNumber;

      const modelStr = modelNumber.trim();

      // Try exact match first
      if (modelNameMapping[modelStr]) {
        return modelNameMapping[modelStr];
      }

      // Extract base model number (e.g., SM-S931 from SM-S931BE_SWA_16_DD)
      const match = modelStr.match(/^(SM-[A-Z]\d{2,4})/);
      if (match) {
        const baseModel = match[1]; // e.g., "SM-S931"

        // Look for mapping keys that start with this base
        for (const [mapKey, friendlyName] of Object.entries(modelNameMapping)) {
          if (mapKey.startsWith(baseModel)) {
            return friendlyName;
          }
        }
      }

      // Fallback: try prefix matching with full mapping keys
      const sortedKeys = Object.keys(modelNameMapping).sort((a, b) => b.length - a.length);
      for (const key of sortedKeys) {
        if (modelStr.startsWith(key)) {
          return modelNameMapping[key];
        }
      }

      // Return original if no match found
      return modelNumber;
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', async function () {
      await loadModelNameMapping(); // Load mapping first
      loadDashboardData();
    });

    // Add accessibility attributes to table headers
    document.addEventListener('DOMContentLoaded', function () {
      // Add scope="col" to table headers for accessibility
      const tableHeaders = document.querySelectorAll('th');
      tableHeaders.forEach(header => {
        header.setAttribute('scope', 'col');
      });
    });

    // Load all dashboard data from central_dashboard.json
    async function loadDashboardData() {
      try {
        // Fetch data from central_dashboard.json (contains all pre-aggregated data)
        const response = await fetch('/downloads/__dashboard_cache__/central_dashboard.json');
        const jsonData = await response.json();

        // Extract data from the JSON structure - use pre-computed values
        dashboardData.kpis = jsonData.kpis;
        dashboardData.totalIssues = jsonData.total_issues;
        dashboardData.highIssuesCount = jsonData.high_issues_count;
        dashboardData.topModules = jsonData.top_modules;
        dashboardData.topModels = jsonData.top_models;
        dashboardData.seriesDistribution = jsonData.series_distribution;
        dashboardData.sourceModelSummary = jsonData.source_model_summary;
        dashboardData.modelModuleMatrix = jsonData.model_module_matrix;
        dashboardData.filteredTopModels = jsonData.filtered_top_models;
        dashboardData.totalUniqueModels = jsonData.total_unique_models;
        dashboardData.totalUniqueModules = jsonData.total_unique_modules;

        // Update all UI elements
        createModelSummaryTable();

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Keep static data as fallback
      }
    }

    // Update KPI values
    function updateKPIs() {
      // Update KPI elements using correct IDs - use pre-computed values
      const totalIssuesEl = document.getElementById('total-issues');
      const openIssuesEl = document.getElementById('open-issues');
      const resolvedIssuesEl = document.getElementById('resolved-issues');
      const closeIssuesEl = document.getElementById('close-issues');

      // Use pre-computed values from backend
      // Update Total to include ALL issues (Open + Resolved + Close)
      const totalOpen = Object.values(dashboardData.kpis).reduce((sum, kpi) => sum + (kpi?.open || 0), 0);
      const totalResolved = Object.values(dashboardData.kpis).reduce((sum, kpi) => sum + (kpi?.resolved || 0), 0);
      const totalClose = Object.values(dashboardData.kpis).reduce((sum, kpi) => sum + (kpi?.close || 0), 0);

      const grandTotal = totalOpen + totalResolved + totalClose;
      if (totalIssuesEl) totalIssuesEl.textContent = grandTotal.toLocaleString();

      if (openIssuesEl) openIssuesEl.textContent = totalOpen.toLocaleString();
      if (resolvedIssuesEl) resolvedIssuesEl.textContent = totalResolved.toLocaleString();
      if (closeIssuesEl) closeIssuesEl.textContent = totalClose.toLocaleString();
    }

    // Update source distribution chart - 100% Stacked Horizontal Bar
    function updateSourceDistribution() {
      const chartDom = document.getElementById('source-distribution-chart');
      if (!chartDom) {
        return;
      }

      console.log("HTML Dashboard - Updating source distribution");
      console.log("KPIs data:", dashboardData.kpis);

      const chart = echarts.init(chartDom);
      const colors = getChartColors();

      // Use actual severity data from KPIs instead of classifying by count
      const severityData = dashboardData.kpis || {};
      console.log("Severity data from KPIs:", severityData);

      // Map display names to KPI keys
      const displayToKPI = {
        'Beta Users': 'Beta User Issues',
        'S.M. PLM': 'Samsung Members PLM',
        'S.M. VOC': 'Samsung Members VOC'
      };

      const sources = ['Beta Users', 'S.M. PLM', 'S.M. VOC'];

      // Extract severity counts directly from KPIs
      const highData = sources.map(source => {
        const kpiKey = displayToKPI[source];
        const value = severityData[kpiKey]?.High || 0;
        console.log(`High for ${source} (${kpiKey}):`, value);
        return value;
      });

      const mediumData = sources.map(source => {
        const kpiKey = displayToKPI[source];
        const value = severityData[kpiKey]?.Medium || 0;
        console.log(`Medium for ${source} (${kpiKey}):`, value);
        return value;
      });

      const lowData = sources.map(source => {
        const kpiKey = displayToKPI[source];
        const value = severityData[kpiKey]?.Low || 0;
        console.log(`Low for ${source} (${kpiKey}):`, value);
        return value;
      });

      console.log("Final data arrays - High:", highData, "Medium:", mediumData, "Low:", lowData);

      // Create mapping from display names to data keys
      const displayNameToKey = {
        'Beta Users': 'Beta',
        'S.M. PLM': 'PLM',
        'S.M. VOC': 'VOC'
      };

      const option = {
        textStyle: {
          color: colors.textPrimary
        },
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            let result = '';
            params.forEach(param => {
              const source = param.name;
              const severity = param.seriesName;
              const value = param.value;
              result += `${source}<br/>${severity}: ${value}<br/>`;
            });
            return result;
          }
        },
        legend: {
          data: ['High', 'Medium', 'Low'],
          bottom: 0,
          orient: 'horizontal',
          textStyle: {
            color: colors.textPrimary
          }
        },
        grid: {
          left: '20%',
          right: '0%',
          top: '10%',
          bottom: '20%',
          borderColor: colors.gridLines
        },
        xAxis: {
          type: 'value',
          axisLabel: {
            show: false,
            fontSize: 10,
            color: colors.textPrimary
          },
          splitLine: {
            show: false
          }
        },
        yAxis: {
          type: 'category',
          data: ['Beta Users', 'S.M. PLM', 'S.M. VOC'], // Match the order of sources array
          axisLabel: {
            fontSize: 12,
            interval: 0,
            color: colors.textPrimary
          }
        },
        series: [
          {
            name: 'High',
            type: 'bar',
            stack: 'total',
            barWidth: '50%', // Thicker bars for cylindrical effect
            data: highData,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: '#ef4444' },
                { offset: 0.5, color: '#dc2626' },
                { offset: 1, color: '#b91c1c' }
              ]),
              borderRadius: [12, 0, 0, 12],
              shadowBlur: 8,
              shadowColor: 'rgba(239, 68, 68, 0.3)'
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                shadowBlur: 12,
                shadowColor: 'rgba(239, 68, 68, 0.5)'
              }
            },
            label: {
              show: true,
              position: 'inside',
              formatter: '{c}',
              fontSize: 12,
              color: colors.textPrimary
            }
          },
          {
            name: 'Medium',
            type: 'bar',
            stack: 'total',
            barWidth: '70%',
            data: mediumData,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: '#fbbf24' },
                { offset: 0.5, color: '#f59e0b' },
                { offset: 1, color: '#d97706' }
              ]),
              borderRadius: [0, 0, 0, 0],
              shadowBlur: 8,
              shadowColor: 'rgba(245, 158, 11, 0.3)',
              opacity: 0.75
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                opacity: 1,
                shadowBlur: 12,
                shadowColor: 'rgba(245, 158, 11, 0.5)'
              }
            },
            label: {
              show: true,
              position: 'inside',
              formatter: '{c}',
              fontSize: 12,
              color: colors.textPrimary
            }
          },
          {
            name: 'Low',
            type: 'bar',
            stack: 'total',
            barWidth: '70%',
            data: lowData,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: '#9ca3af' },
                { offset: 0.5, color: '#6b7280' },
                { offset: 1, color: '#4b5563' }
              ]),
              borderRadius: [4, 4, 0, 0],
              shadowBlur: 8,
              shadowColor: 'rgba(107, 114, 128, 0.3)'
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                shadowBlur: 12,
                shadowColor: 'rgba(107, 114, 128, 0.5)'
              }
            },
            label: {
              show: true,
              position: 'inside',
              formatter: '{c}',
              fontSize: 12,
              color: colors.textPrimary
            }
          }
        ]
      };

      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    }

    // Update model summary table
    async function createModelSummaryTable() {
      console.log('createModelSummaryTable called');

      const tbody = document.getElementById('model-summary-table-body');
      if (!tbody) {
        console.error('Table body element not found');
        return;
      }

      // Clear existing content
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-slate-500">Loading data...</td></tr>';

      try {
        // Fetch new data source specifically for this table
        const response = await fetch('/downloads/global_voc_PLM/analytics.json');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const analyticsData = await response.json();

        if (!analyticsData.rows || !Array.isArray(analyticsData.rows)) {
          console.error('Invalid data format in analytics.json: expected "rows" array');
          tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error: Invalid data format</td></tr>';
          return;
        }

        tbody.innerHTML = ''; // Clear loading message

        // Store and compute fields into global array
        globalTableData = analyticsData.rows.map(item => {
          // Get model number from data
          const modelNumber = item['Model No.'] || 'N/A';
          const modelStr = modelNumber.trim();

          // Get friendly name
          const friendlyName = applyModelNameMapping(modelNumber);

          // Get chipset directly from the original model string first, fallback to checking base prefix
          let chipset = 'N/A';
          if (modelNameMapping[modelStr] && modelNameMapping[modelStr].chipset) {
            chipset = modelNameMapping[modelStr].chipset;
          } else {
            const match = modelStr.match(/^(SM-[A-Z]\d{2,4})/);
            if (match) {
              const baseModel = match[1];
              for (const [mapKey, mappingData] of Object.entries(modelNameMapping)) {
                if (typeof mappingData === 'object' && mapKey.startsWith(baseModel) && mappingData.chipset) {
                  chipset = mappingData.chipset;
                  break;
                }
              }
            }
          }

          // Read mapping exactly as requested
          const source = item['Source'] || 'N/A';
          const plmCode = item['Case Code'] || 'N/A';
          const title = item['Title'] || 'No Title Available';
          const status = item['Progr.Stat.'] || 'N/A';

          // Define status color class mapping for UI flair
          let statusColorClass = "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300";
          if (status.toLowerCase().includes('open')) {
            statusColorClass = "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";
          } else if (status.toLowerCase().includes('resolve') || status.toLowerCase().includes('close')) {
            statusColorClass = "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";
          } else if (status.toLowerCase().includes('progress')) {
            statusColorClass = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300";
          }

          let modelDisplay = modelNumber !== 'N/A' ? modelNumber : friendlyName;

          return {
            source,
            model: modelDisplay,
            chipset,
            plm: plmCode,
            title,
            status,
            statusColorClass
          };
        });

        // Initialize display
        renderTable();
        console.log(`Finished mapping and rendering Top Critical Market Issues table with ${analyticsData.rows.length} rows.`);

      } catch (error) {
        console.error('Failed to load global_voc_PLM/analytics.json:', error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Failed to load table data.</td></tr>`;
      }
    }

    // Render table from global array
    function renderTable() {
      const tbody = document.getElementById('model-summary-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';

      let serialNumber = 1;
      globalTableData.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors divide-x divide-slate-200 dark:divide-slate-700';
        tr.innerHTML = `
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 text-center align-middle">${serialNumber++}</td>
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 text-center align-middle">${item.source}</td>
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 text-center align-middle">${item.model}</td>
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 text-center align-middle">${item.chipset}</td>
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 text-center align-middle">${item.plm}</td>
          <td class="px-4 py-3 text-xs text-slate-700 dark:text-slate-300 max-w-sm truncate text-left align-middle" title="${item.title}">${item.title}</td>
          <td class="px-4 py-3 text-xs text-center align-middle">
            <span class="px-2 py-1 inline-flex text-xs leading-tight font-semibold rounded-full ${item.statusColorClass}">
              ${item.status}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Sort table globally and re-render
    function sortTable(column) {
      if (currentSortColumn === column) {
        isAscending = !isAscending;
      } else {
        currentSortColumn = column;
        isAscending = true;
      }

      // Reset all icons to default sort state
      ['source', 'model', 'chipset', 'plm', 'title', 'status'].forEach(col => {
        const icon = document.getElementById(`sort-icon-${col}`);
        if (icon) {
          icon.className = 'fa-solid fa-sort text-slate-300 dark:text-slate-500 group-hover:text-slate-400';
        }
      });

      // Highlight the targeted one
      const currentIcon = document.getElementById(`sort-icon-${column}`);
      if (currentIcon) {
        currentIcon.className = `fa-solid ${isAscending ? 'fa-sort-up' : 'fa-sort-down'} text-indigo-500 dark:text-indigo-400`;
      }

      // Sort data
      globalTableData.sort((a, b) => {
        let valA = a[column] ? a[column].toString().toLowerCase() : '';
        let valB = b[column] ? b[column].toString().toLowerCase() : '';

        if (valA < valB) return isAscending ? -1 : 1;
        if (valA > valB) return isAscending ? 1 : -1;
        return 0;
      });

      renderTable();
    }

    // Update timestamp
    function updateTimestamp() {
      const now = new Date();
      const formatted = now.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      // Note: main.html doesn't have a timestamp element, so this is for future use
    }

    // Show details modal with comprehensive data
    function showDetailsModal() {
      const modal = document.getElementById('details-modal');
      const totalModelsEl = document.getElementById('modal-total-models');
      const totalIssuesEl = document.getElementById('modal-total-issues');
      const highRiskEl = document.getElementById('modal-high-risk');
      const tbody = document.getElementById('modal-table-body');

      if (!modal || !tbody) return;

      // Calculate stats
      const totalIssues = Object.values(dashboardData.kpis).reduce((sum, val) => sum + val, 0);
      const totalModels = dashboardData.topModels.length;
      const highRiskModels = dashboardData.topModels.filter(model =>
        model.value > 200 // Models with more than 200 issues are considered high risk
      ).length;

      // Update stats
      if (totalModelsEl) totalModelsEl.textContent = totalModels;
      if (totalIssuesEl) totalIssuesEl.textContent = totalIssues;
      if (highRiskEl) highRiskEl.textContent = highRiskModels;

      // Clear existing content
      tbody.innerHTML = '';

      // Generate comprehensive table with all available models using real analytics data
      dashboardData.topModels.forEach((model, index) => {
        // Get real model data from source_model_summary
        const modelData = dashboardData.sourceModelSummary?.find(item =>
          item.model === model.label
        );

        // Use real data if available, otherwise fallback
        const topModule = modelData?.top_modules?.[0] || 'N/A';
        const topIssue = modelData?.top_titles?.[0] || 'Various issues reported';
        const source = modelData?.source || 'Unknown';

        // Map source to display name
        const sourceDisplayName = {
          'Beta': 'Beta User Issues',
          'PLM': 'S.M. PLM',
          'VOC': 'S.M. VOC'
        }[source] || source;

        // Determine severity based on actual issue count from analytics
        const issueCount = modelData?.issue_count || model.value;
        const severity = issueCount > 300 ? 'critical' : issueCount > 200 ? 'high' : issueCount > 100 ? 'medium' : 'low';
        const severityIcon = severity === 'critical' ? 'fa-circle' :
          severity === 'high' ? 'fa-triangle-exclamation' :
            severity === 'medium' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        const severityText = severity.charAt(0).toUpperCase() + severity.slice(1);

        // Risk level based on severity
        const riskClass = severity === 'critical' ? 'high' : severity === 'high' ? 'high' : 'major';
        const riskText = riskClass === 'high' ? 'High Risk' : 'Major Risk';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          < td class="px-4 py-3 text-sm text-slate-900" > ${index + 1}</td >
      <td class="px-4 py-3 text-sm text-slate-900">${model.label}</td>
      <td class="px-4 py-3 text-sm text-slate-500">${topModule}</td>
      <td class="px-4 py-3 text-sm text-slate-500">${sourceDisplayName}</td>
      <td class="px-4 py-3 text-sm text-slate-900">${issueCount}</td>
      <td class="px-4 py-3 text-sm">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${severity === 'high' ? 'bg-red-100 text-red-800' : severity === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-800'}">
          <i class="fa-solid ${severityIcon} mr-1"></i> ${severityText}
        </span>
      </td>
      <td class="px-4 py-3 text-sm">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${riskClass === 'high' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
          <i class="fa-solid fa-circle-exclamation"></i>
        </span>
      </td>
    `;
        tbody.appendChild(tr);
      });

      // Show modal using Tailwind classes
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling

      // Add ESC key listener
      document.addEventListener('keydown', handleModalKeydown);
    }

    function closeDetailsModal() {
      const modal = document.getElementById('details-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
      }

      // Remove ESC key listener
      document.removeEventListener('keydown', handleModalKeydown);
    }

    function handleModalKeydown(event) {
      if (event.key === 'Escape') {
        closeDetailsModal();
      }
    }

    // Theme-aware color helper for charts
    function getChartColors() {
      const isDark = document.documentElement.classList.contains('dark');

      return {
        textPrimary: isDark ? '#FFFFFF' : '#000000',
        textSecondary: isDark ? '#FFFFFF' : '#000000',
        gridLines: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'
      };
    }

    // Error handling
    function handleError(error) {
      console.error('Dashboard error:', error);
      // Could show error message to user if needed
    }
  </script>
</body>

</html>