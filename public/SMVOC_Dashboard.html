<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Samsung Members VOC - Overview</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
            },
          },
        },
      },
    }

    // System theme detection
    function updateTheme() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.classList.toggle('dark', isDark);
    }

    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);

    // Set initial theme
    updateTheme();
  </script>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto px-6 py-6">

    <!-- HEADER -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100">Samsung Members VOC - Overview</h1>

      <div class="flex gap-2">
        <a href="main.html"
          class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
          <i class="fa-solid fa-home mr-2"></i>
          Home
        </a>
      </div>
    </div>

    <!-- KPI -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-300 font-medium">Total</p>
            <p class="text-3xl font-bold text-slate-900 dark:text-slate-100 mt-1" id="total-issues">0</p>
          </div>
          <div class="p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
            <i class="fa-solid fa-chart-line text-blue-600 dark:text-blue-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div
        class="bg-red-50 dark:bg-red-950/30 rounded-xl shadow-lg p-6 border-2 border-red-200 dark:border-red-800 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-16 h-16 bg-red-500/10 rounded-full -mr-8 -mt-8"></div>
        <div class="flex items-center justify-between relative z-10">
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-300 font-medium">Open</p>
            <p class="text-3xl font-bold text-red-800 dark:text-red-200 mt-1" id="open-issues">0</p>
          </div>
          <div class="p-3 bg-red-100 dark:bg-red-900/40 rounded-lg">
            <i class="fa-solid fa-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div
        class="bg-yellow-50 dark:bg-yellow-950/30 rounded-xl shadow-lg p-6 border-2 border-yellow-200 dark:border-yellow-800 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-16 h-16 bg-yellow-500/10 rounded-full -mr-8 -mt-8"></div>
        <div class="flex items-center justify-between relative z-10">
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-300 font-medium">Resolved</p>
            <p class="text-3xl font-bold text-yellow-800 dark:text-yellow-200 mt-1" id="resolved-issues">0</p>
          </div>
          <div class="p-3 bg-yellow-100 dark:bg-yellow-900/40 rounded-lg">
            <i class="fa-solid fa-check-circle text-yellow-600 dark:text-yellow-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div
        class="bg-green-50 dark:bg-green-950/30 rounded-xl shadow-lg p-6 border-2 border-green-200 dark:border-green-800 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-16 h-16 bg-green-500/10 rounded-full -mr-8 -mt-8"></div>
        <div class="flex items-center justify-between relative z-10">
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-300 font-medium">Close</p>
            <p class="text-3xl font-bold text-green-800 dark:text-green-200 mt-1" id="close-issues">0</p>
          </div>
          <div class="p-3 bg-green-100 dark:bg-green-900/40 rounded-lg">
            <i class="fa-solid fa-times-circle text-green-600 dark:text-green-400 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTS ROW -->
    <section class="grid grid-cols-12 gap-4">

      <!-- TOP MODELS - Professional Design -->
      <div class="col-span-6">
        <div
          class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 h-[260px]">
          <!-- Header with subtle accent -->
          <div class="border-b border-slate-100 dark:border-slate-700 px-6 py-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Top 10 Models</h3>
              <div class="w-8 h-8 bg-blue-50 dark:bg-blue-950/30 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-chart-bar text-blue-600 dark:text-blue-400"></i>
              </div>
            </div>
          </div>

          <!-- Chart Container -->
          <div class="p-4">
            <div id="top-models-chart" class="h-[180px] w-full"></div>
          </div>
        </div>
      </div>

      <!-- TOP MODULES - Donut Chart -->
      <div class="col-span-6">
        <div
          class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 h-[260px]">
          <!-- Header with subtle accent -->
          <div class="border-b border-slate-100 dark:border-slate-700 px-6 py-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Top 10 Categories</h3>
              <div class="w-8 h-8 bg-blue-50 dark:bg-blue-950/30 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-chart-pie text-blue-600 dark:text-blue-400"></i>
              </div>
            </div>
          </div>

          <!-- Chart Container -->
          <div class="p-4">
            <div id="top-modules-chart" class="h-[180px] w-full"></div>
          </div>
        </div>
      </div>

    </section>

    <!-- MODULE ISSUE BREAKDOWN TABLE -->
    <section class="mt-8">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="border-b border-slate-100 dark:border-slate-700 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Module Issue Breakdown</h3>
            <div class="flex gap-2">
              <button onclick="exportTableToExcel()"
                class="inline-flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg shadow transition-colors duration-200">
                <i class="fa-solid fa-file-excel mr-2"></i>
                Export Excel
              </button>
              <div class="w-8 h-8 bg-indigo-50 dark:bg-indigo-950/30 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-list-check text-indigo-600 dark:text-indigo-400"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full" id="module-breakdown-table">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-[8%]">
                  Model Name
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-[8%]">
                  Module
                </th>
                <th
                  class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-[4%]">
                  Count
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-[40%]">
                  Issue Descriptions
                </th>
                <th onclick="toggleGlobalVocSort()"
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-[40%] cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors select-none group">
                  <div class="flex items-center gap-2">
                    Global VOC PLM
                    <i id="global-voc-sort-icon"
                      class="fa-solid fa-sort text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300 transition-colors"></i>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="module-breakdown-table-body"
              class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Global state
    let dashboardData = {};
    let globalVocData = []; // Store raw global VOC PLM data
    let semanticMatches = {}; // Store pre-calculated semantic matches
    let modelNameMapping = {}; // Model name mapping from modelName.json

    // Load model name mapping
    async function loadModelNameMapping() {
      try {
        const response = await fetch('/modelName.json');
        modelNameMapping = await response.json();
        console.log(`Loaded ${Object.keys(modelNameMapping).length} model name mappings`);
      } catch (error) {
        console.warn('Failed to load modelName.json:', error);
        modelNameMapping = {};
      }
    }

    // Apply model name mapping function
    function applyModelNameMapping(modelNumber) {
      if (!modelNumber || typeof modelNumber !== 'string') return modelNumber;

      const modelStr = modelNumber.trim();

      // Try exact match first
      if (modelNameMapping[modelStr]) {
        return modelNameMapping[modelStr];
      }

      // Extract base model number (e.g., SM-S931 from SM-S931BE_SWA_16_DD)
      const match = modelStr.match(/^(SM-[A-Z]\d{2,4})/);
      if (match) {
        const baseModel = match[1]; // e.g., "SM-S931"

        // Look for mapping keys that start with this base
        for (const [mapKey, friendlyName] of Object.entries(modelNameMapping)) {
          if (mapKey.startsWith(baseModel)) {
            return friendlyName;
          }
        }
      }

      // Fallback: try prefix matching with full mapping keys
      const sortedKeys = Object.keys(modelNameMapping).sort((a, b) => b.length - a.length);
      for (const key of sortedKeys) {
        if (modelStr.startsWith(key)) {
          return modelNameMapping[key];
        }
      }

      // Return original if no match found
      return modelNumber;
    }

    // Initialize dashboard when page loads
    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', async function () {
      await loadModelNameMapping();
      loadDashboardData();
    });

    // Load all dashboard data from analytics.json (NOT central_dashboard.json)
    async function loadDashboardData() {
      try {
        // Fetch analytics data directly
        const analyticsResponse = await fetch('/downloads/samsung_members_voc/analytics.json');
        const analyticsData = await analyticsResponse.json();

        // Fetch Global VOC PLM data
        try {
          const globalVocResponse = await fetch('/downloads/global_voc_plm/analytics.json');
          const globalVocJson = await globalVocResponse.json();
          globalVocData = globalVocJson.rows || [];
        } catch (e) {
          console.warn('Failed to load global VOC PLM data', e);
          globalVocData = [];
        }

        // Fetch Semantic Matches
        try {
          const semanticResponse = await fetch('/downloads/samsung_members_voc/semantic_matches.json');
          semanticMatches = await semanticResponse.json();
        } catch (e) {
          console.warn('Failed to load semantic matches:', e);
          semanticMatches = {};
        }

        // Extract Samsung Members VOC specific data from analytics
        dashboardData.kpis = analyticsData.kpis || { total_rows: 0, open_issues: 0, resolved_issues: 0, close_issues: 0 };
        dashboardData.topModels = analyticsData.top_models || [];
        dashboardData.topModules = analyticsData.categories || [];
        dashboardData.analytics = analyticsData;

        // Update all UI elements
        updateKPIs();
        updateTopModelsChart();
        updateTopModulesChart();
        updateModuleBreakdownTable();

      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Update KPI values
    function updateKPIs() {
      if (!dashboardData.kpis) return;

      const totalEl = document.getElementById('total-issues');
      const openEl = document.getElementById('open-issues');
      const resolvedEl = document.getElementById('resolved-issues');
      const closeEl = document.getElementById('close-issues');

      // Use analytics data directly
      if (totalEl) totalEl.textContent = (dashboardData.kpis.total_rows || 0).toLocaleString();
      if (openEl) openEl.textContent = (dashboardData.kpis.open_issues || 0).toLocaleString();
      if (resolvedEl) resolvedEl.textContent = (dashboardData.kpis.resolved_issues || 0).toLocaleString();
      if (closeEl) closeEl.textContent = (dashboardData.kpis.close_issues || 0).toLocaleString();
    }

    // Update Module Breakdown Table
    function updateModuleBreakdownTable() {
      const tbody = document.getElementById('module-breakdown-table-body');
      if (!tbody || !dashboardData.analytics || !dashboardData.analytics.rows) return;

      tbody.innerHTML = '';

      tbody.innerHTML = '';

      // 1. Process Data using helper
      const moduleData = processModuleData();

      // 2. Sort Modules using helper (handles sorting state)
      const sortedModules = sortModules(moduleData);

      // Render table rows
      sortedModules.forEach(([moduleName, data]) => {
        const tr = document.createElement('tr');
        tr.className = ''; // Removed hover effect as requested

        // Sort sub-modules by count descending and take top 5
        const sortedSubModules = Object.entries(data.subModules)
          .sort(([, a], [, b]) => b.count - a.count)
          .slice(0, 5); // Top 5 sub-modules

        // Create nested sub-module and insights HTML
        let subModuleHTML = '<div class="space-y-3">';
        sortedSubModules.forEach(([subModule, subData]) => {
          // Sort insights by count descending and take top 3
          const sortedInsights = Object.entries(subData.insights)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 3); // Top 3 insights per sub-module

          subModuleHTML += `
            <div class="mb-2">
              <div class="font-semibold text-slate-800 dark:text-slate-200 mb-1">
                <span class="inline-block w-2 h-2 rounded-full bg-indigo-500 mr-2"></span>
                ${subModule} <span class="text-indigo-600 dark:text-indigo-400">(${subData.count})</span>
              </div>
              <ul class="ml-6 space-y-1">
          `;

          sortedInsights.forEach(([insight, count]) => {
            subModuleHTML += `
              <li class="text-sm text-slate-600 dark:text-slate-400">
                <span class="inline-block w-1.5 h-1.5 rounded-full bg-slate-400 dark:bg-slate-500 mr-2"></span>
                ${insight} <span class="font-medium text-slate-900 dark:text-slate-100">(${count})</span>
              </li>
            `;
          });

          subModuleHTML += `
              </ul>
            </div>
          `;
        });
        subModuleHTML += '</div>';

        // Process model names
        const friendlyModelNames = Array.from(data.models)
          .map(modelNo => applyModelNameMapping(modelNo))
          .sort();
        const modelNamesDisplay = [...new Set(friendlyModelNames)].join(', ');

        // Find matching Global VOC PLM cases
        // Use Pre-Calculated Semantic Matches (fuzzy matching from server)
        // Find matching Global VOC PLM cases
        // Use Pre-Calculated Semantic Matches (fuzzy matching from server)
        const matchedCases = getGlobalVocMatches(data.signatures);

        // Group by Sub-Module and deduplicate cases
        const gvBySubModule = {};
        const seenCodes = new Set();

        matchedCases.forEach(c => {
          if (!seenCodes.has(c.code)) {
            seenCodes.add(c.code);
            if (!gvBySubModule[c.subModule]) {
              gvBySubModule[c.subModule] = [];
            }
            gvBySubModule[c.subModule].push(c);
          }
        });

        let globalVocHTML = '';
        const sortedSubMods = Object.keys(gvBySubModule).sort();

        if (sortedSubMods.length > 0) {
          globalVocHTML = '<div class="space-y-3">';
          sortedSubMods.forEach(subMod => {
            const cases = gvBySubModule[subMod];
            globalVocHTML += `
              <div class="mb-2">
                <div class="font-semibold text-slate-800 dark:text-slate-200 mb-1 flex items-center">
                  <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
                  ${subMod} <span class="text-xs text-emerald-600 dark:text-emerald-400 ml-1">(${cases.length})</span>
                </div>
                <ul class="ml-5 space-y-1 border-l-2 border-slate-100 dark:border-slate-700 pl-2">
            `;

            cases.forEach(c => {
              globalVocHTML += `
                <li class="text-xs text-slate-600 dark:text-slate-400 mb-1">
                  <span class="font-mono font-bold text-blue-600 dark:text-blue-400 select-all mr-1">${c.code}</span>: 
                  <span title="${c.title}">${c.title}</span>
                </li>
              `;
            });

            globalVocHTML += `
                </ul>
              </div>
            `;
          });
          globalVocHTML += '</div>';
        } else {
          globalVocHTML = '<span class="text-xs text-slate-400 italic">No matching Global VOC cases</span>';
        }

        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-slate-700 dark:text-slate-300 align-top">
            ${modelNamesDisplay}
          </td>
          <td class="px-4 py-3 text-sm font-medium text-slate-900 dark:text-slate-100 align-top">
            ${moduleName}
          </td>
          <td class="px-4 py-3 text-sm text-center font-semibold text-slate-900 dark:text-slate-100 align-top">
            ${data.count}
          </td>
          <td class="px-4 py-3 align-top">
            ${subModuleHTML}
          </td>
          <td class="px-4 py-3 text-sm align-top">
             ${globalVocHTML}
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // Update top models chart - Bar Chart
    function updateTopModelsChart() {
      const chartDom = document.getElementById('top-models-chart');
      if (!chartDom || !dashboardData.topModels) return;

      const chart = echarts.init(chartDom);
      const colors = getChartColors();

      // Take top 10 models
      const topModels = dashboardData.topModels.slice(0, 10).reverse();
      const modelNames = topModels.map(model => {
        return model.label.length > 12 ? model.label.substring(0, 12) + '...' : model.label;
      });
      const issueCounts = topModels.map(model => model.count);

      const option = {
        textStyle: {
          color: colors.textPrimary
        },
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            const modelIndex = params[0].dataIndex;
            const fullName = topModels[modelIndex].label;
            const count = params[0].value;
            return `${fullName}<br/>Issues: ${count}`;
          }
        },
        grid: {
          left: '3%',
          right: '10%',
          top: '8%',
          bottom: '8%',
          containLabel: true,
          borderColor: colors.gridLines
        },
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: modelNames,
          axisLabel: {
            interval: 0,
            rotate: 0,
            fontSize: 11,
            color: colors.textPrimary
          }
        },
        series: [
          {
            name: 'Issues',
            type: 'bar',
            barWidth: '60%',
            data: issueCounts,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: '#0ea5e9' },
                { offset: 0.5, color: '#0284c7' },
                { offset: 1, color: '#0369a1' }
              ]),
              borderRadius: [4, 4, 4, 4]
            },
            label: {
              show: true,
              position: 'right',
              formatter: '{c}',
              fontSize: 11,
              color: colors.textPrimary
            }
          }
        ]
      };

      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    }

    // Update top modules chart - Bar Chart
    function updateTopModulesChart() {
      const chartDom = document.getElementById('top-modules-chart');
      if (!chartDom || !dashboardData.topModules) return;

      const chart = echarts.init(chartDom);
      const colors = getChartColors();

      // Take top 10 modules
      const topModules = dashboardData.topModules.slice(0, 10).reverse();
      const moduleNames = topModules.map(module => {
        return module.label.length > 15 ? module.label.substring(0, 15) + '...' : module.label;
      });
      const issueCounts = topModules.map(module => module.count);

      const option = {
        textStyle: {
          color: colors.textPrimary
        },
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            const moduleIndex = params[0].dataIndex;
            const fullName = topModules[moduleIndex].label;
            const count = params[0].value;
            return `${fullName}<br/>Issues: ${count}`;
          }
        },
        grid: {
          left: '3%',
          right: '10%',
          top: '8%',
          bottom: '8%',
          containLabel: true,
          borderColor: colors.gridLines
        },
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: moduleNames,
          axisLabel: {
            interval: 0,
            rotate: 0,
            fontSize: 10,
            color: colors.textPrimary
          }
        },
        series: [
          {
            name: 'Issues',
            type: 'bar',
            barWidth: '60%',
            data: issueCounts,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                { offset: 0, color: '#10b981' },
                { offset: 0.5, color: '#059669' },
                { offset: 1, color: '#047857' }
              ]),
              borderRadius: [4, 4, 4, 4]
            },
            label: {
              show: true,
              position: 'right',
              formatter: '{c}',
              fontSize: 11,
              color: colors.textPrimary
            }
          }
        ]
      };

      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    }






    // Sorting State
    let globalVocSortState = 'none'; // 'none', 'asc', 'desc'

    // Toggle Global VOC Sort
    function toggleGlobalVocSort() {
      const icon = document.getElementById('global-voc-sort-icon');

      if (globalVocSortState === 'none') {
        globalVocSortState = 'desc';
        icon.className = 'fa-solid fa-sort-down text-indigo-600 dark:text-indigo-400 transition-colors';
      } else if (globalVocSortState === 'desc') {
        globalVocSortState = 'asc';
        icon.className = 'fa-solid fa-sort-up text-indigo-600 dark:text-indigo-400 transition-colors';
      } else {
        globalVocSortState = 'none';
        icon.className = 'fa-solid fa-sort text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300 transition-colors';
      }

      updateModuleBreakdownTable();
    }

    // Export to Excel
    function exportTableToExcel() {
      if (!dashboardData.analytics || !dashboardData.analytics.rows) return;

      // 1. Prepare Data
      // We need to replicate the logic from updateModuleBreakdownTable to get the exact same rows
      const moduleData = processModuleData(); // Extract processing logic to reuse

      // Sort modules based on current table sort state
      const sortedModules = sortModules(moduleData);

      // Flatten data for Excel
      const excelRows = [];

      sortedModules.forEach(([moduleName, data]) => {
        // Get friendly model names
        const friendlyModelNames = Array.from(data.models)
          .map(modelNo => applyModelNameMapping(modelNo))
          .sort();
        const modelNamesDisplay = [...new Set(friendlyModelNames)].join(', ');

        // Get Sub-modules and Issues
        const sortedSubModules = Object.entries(data.subModules)
          .sort(([, a], [, b]) => b.count - a.count);

        // Get Global VOC matches
        const globalVocMatches = getGlobalVocMatches(data.signatures);
        const gvBySubModule = {};
        const seenCodes = new Set();

        globalVocMatches.forEach(c => {
          if (!seenCodes.has(c.code)) {
            seenCodes.add(c.code);
            if (!gvBySubModule[c.subModule]) gvBySubModule[c.subModule] = [];
            gvBySubModule[c.subModule].push(c);
          }
        });

        // Create a row for each sub-module/insight combination or just aggregation
        // To make it readable in Excel, we'll format it as:
        // Model | Module | Count | Issue Descriptions (Text) | Global VOC PLM (Text)

        let issueDescText = "";
        sortedSubModules.forEach(([subMod, subData]) => {
          issueDescText += `${subMod} (${subData.count})\n`;
          const sortedInsights = Object.entries(subData.insights)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // Take top 5 for text
          sortedInsights.forEach(([insight, count]) => {
            issueDescText += `  - ${insight} (${count})\n`;
          });
          issueDescText += "\n";
        });

        let globalVocText = "";
        Object.keys(gvBySubModule).sort().forEach(subMod => {
          const cases = gvBySubModule[subMod];
          globalVocText += `${subMod} (${cases.length})\n`;
          cases.forEach(c => {
            globalVocText += `  - ${c.code}: ${c.title}\n`;
          });
          globalVocText += "\n";
        });

        excelRows.push({
          "Model Name": modelNamesDisplay,
          "Module": moduleName,
          "Count": data.count,
          "Issue Descriptions": issueDescText.trim(),
          "Global VOC PLM": globalVocText.trim()
        });
      });

      // 2. Create Workbook
      const ws = XLSX.utils.json_to_sheet(excelRows);

      // Auto-width columns
      const colWidths = [
        { wch: 30 }, // Model
        { wch: 20 }, // Module
        { wch: 10 }, // Count
        { wch: 60 }, // Issue Desc
        { wch: 60 }  // Global VOC
      ];
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Module Breakdown");

      // 3. Download
      XLSX.writeFile(wb, "Module_Issue_Breakdown.xlsx");
    }

    // Helper: Process Module Data (extracted from updateModuleBreakdownTable)
    function processModuleData() {
      const moduleData = {};

      // Helper: Normalize Text
      function normalizeKeyText(text) {
        if (!text) return "";
        return text.replace(/_x000d_/g, ' ')
          .replace(/[\r\n]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
          .toLowerCase();
      }

      // Re-create the signature set if needed, but we can just process rows
      dashboardData.analytics.rows.forEach(row => {
        const module = row['Module'] || 'Unknown';
        const subModule = row['Sub-Module'] || 'Unknown';
        const aiInsight = row['AI Insight'] || 'No description available';
        const modelNo = row['Model No.'] || '';
        const content = row['content'] || '';

        // Add to signature set for matching
        let signature = null;
        if (modelNo && module && content) {
          const friendlyModel = applyModelNameMapping(modelNo);
          // Normalize: remove _x000d_, collapse spaces
          const normContent = normalizeKeyText(content);
          signature = `${friendlyModel}|${module}|${normContent}`;
        }

        row._signature = signature; // Store for easy lookup

        const sig = row._signature; // Already calculated on load/update

        if (!moduleData[module]) {
          moduleData[module] = {
            count: 0,
            subModules: {},
            models: new Set(),
            signatures: new Set()
          };
        }

        moduleData[module].count++;
        if (modelNo) moduleData[module].models.add(modelNo);
        if (sig) moduleData[module].signatures.add(sig);

        if (!moduleData[module].subModules[subModule]) {
          moduleData[module].subModules[subModule] = { count: 0, insights: {} };
        }
        moduleData[module].subModules[subModule].count++;

        if (!moduleData[module].subModules[subModule].insights[aiInsight]) {
          moduleData[module].subModules[subModule].insights[aiInsight] = 0;
        }
        moduleData[module].subModules[subModule].insights[aiInsight]++;
      });
      return moduleData;
    }

    // Helper: Get Global VOC Matches for a set of signatures
    function getGlobalVocMatches(signatures) {
      const matchedCases = [];
      const processedSignatures = new Set();

      if (signatures && signatures.size > 0) {
        signatures.forEach(sig => {
          if (processedSignatures.has(sig)) return;
          processedSignatures.add(sig);

          const matches = semanticMatches[sig];
          if (matches && matches.length > 0) {
            matches.forEach(m => {
              matchedCases.push({
                code: m.code,
                title: m.title,
                subModule: m.subModule || 'General'
              });
            });
          }
        });
      }
      return matchedCases;
    }

    // Helper: Sort Modules based on state
    function sortModules(moduleData) {
      let entries = Object.entries(moduleData);

      if (globalVocSortState === 'none') {
        // Default: Sort by Module Count Descending
        return entries.sort(([, a], [, b]) => b.count - a.count).slice(0, 10);
      }

      // Sort by Global VOC match count
      entries.sort(([, a], [, b]) => {
        const matchesA = getGlobalVocMatches(a.signatures).length;
        const matchesB = getGlobalVocMatches(b.signatures).length;

        return globalVocSortState === 'asc' ? matchesA - matchesB : matchesB - matchesA;
      });

      return entries.slice(0, 10);
    }


    // Theme-aware color helper
    function getChartColors() {
      const isDark = document.documentElement.classList.contains('dark');

      return {
        textPrimary: isDark ? '#FFFFFF' : '#000000',
        textSecondary: isDark ? '#FFFFFF' : '#000000',
        gridLines: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'
      };
    }
  </script>
</body>

</html>